// Webpack for transpiling externals (aka vendors) chunk/asset file, for gathering up heavy and rarely-changed
// (and so, nicely cacheable) libs and dependencies - React etc.
// Basis for externals (affects other transpilations too): webpack.config.constants.json
//
// Output, externals.[contentHash].js, is content-hashed file name for cache busting, hash is stored for
// runtime reference in commonChunks.json.

const path = require('path');
const fs = require('fs');

const Chunks2json = require('chunks-2-json-webpack-plugin');
const React4xpConstants = require('react4xp-buildconstants');

const CONSTANTSFILEPATH = path.join(__dirname, "webpack.config.constants.json");

const { SRC_R4X, BUILD_R4X, RELATIVE_BUILD_R4X, BUILD_ENV } = React4xpConstants(
    __dirname,
    {JSON_CONSTANTS_FILE: CONSTANTSFILEPATH}
);


function autogenerateExternalsSourceAndGetFilename(inputFileName, outputFileName) {
    const exts = (require(inputFileName) || {}).EXTERNALS || {};

    let externalsImports = "";
    let externalsExports = "";

    Object.keys(exts).forEach( key => {
        externalsImports += `import ${exts[key]} from '${key}';\n`;
    });

    /*Object.keys(exts).forEach( key => {
        externalsImports += `console.log('${exts[key]}: ' + ${exts[key]});\n`;
    }); //*/

    Object.keys(exts).forEach( key => {
        externalsExports += `\twindow.${exts[key]} = ${exts[key]};\n`;
    });

    const externalsES6 = `// AUTO-GENERATED by ${__filename}\n\n` +
        externalsImports +
        "\n(function(window) {\n" +
        externalsExports +
        "} )(typeof window !== 'undefined' ? window : global);\n"

    fs.writeFileSync(outputFileName, externalsES6);

    return outputFileName;
}




module.exports = {
    mode: BUILD_ENV,

    entry: {
        // First autogenerates an externals sourcefile, and then lets webpack have its filename in order to transpile it
        'externals': autogenerateExternalsSourceAndGetFilename(
            CONSTANTSFILEPATH,
            path.join(SRC_R4X, '_AUTOGENERATED_externals_.es6')
        ),
    },

    output: {
        path: BUILD_R4X,  // <-- Sets the base url for plugins and other target dirs. Note the use of {{assetUrl}} in index.html (or index.ejs).
        filename: "[name].[contenthash:9].js",
    },

    resolve: {
        extensions: ['.es6', '.js', '.jsx']
    },
    module: {
        rules: [
            {
                test: /\.((jsx?)|(es6))$/,
                exclude:  /node_modules/,
                loader: 'babel-loader',
                query: {
                    compact: (BUILD_ENV === 'production'),
                }
            }
        ]
    },

    plugins: [
        new Chunks2json({ outputDir: RELATIVE_BUILD_R4X, filename: 'chunks.externals.json' }),
    ],
};
