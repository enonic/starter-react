// Webpack for transpiling externals (aka vendors) chunk/asset file, for gathering up heavy and rarely-changed
// (and so, nicely cacheable) libs and dependencies - React etc.
// Basis for externals (affects other transpilations too): webpack.config.constants.json
//
// Output, externals.[contentHash].js, is content-hashed file name for cache busting, hash is stored for
// runtime reference in commonChunks.json.

const path = require('path');

const Chunks2json = require('chunks-2-json-webpack-plugin');
const React4xpConstants = require('react4xp-buildconstants');

const { SRC_R4X, BUILD_R4X, RELATIVE_BUILD_R4X, BUILD_ENV } = React4xpConstants(__dirname, {JSON_CONSTANTS_FILE: path.join(__dirname, "webpack.config.constants.json")});

module.exports = {
    mode: BUILD_ENV,

    entry: {
        // Built during the gradle step that triggers this webpack step: webpack_r4xp_externals
        'externals': path.join(SRC_R4X, '_AUTOGENERATED_externals_.es6'),
    },

    output: {
        path: BUILD_R4X,  // <-- Sets the base url for plugins and other target dirs. Note the use of {{assetUrl}} in index.html (or index.ejs).
        filename: "[name].[contenthash:9].js",
    },

    resolve: {
        extensions: ['.es6', '.js', '.jsx']
    },
    module: {
        rules: [
            {
                test: /\.((jsx?)|(es6))$/,
                exclude:  /node_modules/,
                loader: 'babel-loader',
                query: {
                    compact: (BUILD_ENV === 'production'),
                }
            }
        ]
    },

    plugins: [
        new Chunks2json({ outputDir: RELATIVE_BUILD_R4X, filename: 'chunks.externals.json' }),
    ],
};
